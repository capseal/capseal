# ENN-CPP Source Documentation

## 1. System Overview

**ENN-CPP** is a high-performance C++17 implementation of Epistemic Neural Networks (ENNs) optimized for sequential data. It is designed to work in tandem with the BICEP simulator, ingesting trajectory data to learn and predict path properties (like committor functions) while quantifying uncertainty.

The core architecture combines a 1D Convolutional frontend (for temporal feature extraction) with an "Entangled" Recurrent Cell (for epistemic uncertainty propagation) and an Attention-based readout mechanism.

## 2. Core Components (`include/enn/`, `src/`)

### 2.1. Entangled Cell (`cell.hpp`, `cell.cpp`)
The heart of the epistemic engine.
*   **`EntangledCell`**: A recurrent unit that maintains a hidden state $h_t$ and an "entangled" state $\psi_t$ of dimension $k$.
*   **Mechanism**:
    *   Forward pass: $\psi_{out} = \tanh(W_x x + W_h h + (LL^T - \lambda I)\psi_{in} + b)$.
    *   **Entanglement Matrix**: $E = LL^T$ models correlations between ensemble members/particles within the single vector representation $\psi$.
    *   **Regularization**: Enforces Positive Semi-Definiteness (PSD) on $E$ via Cholesky parameterization $L$.

### 2.2. Collapse Mechanism (`collapse.hpp`, `collapse.cpp`)
Converts the high-dimensional entangled state $\psi$ into a scalar prediction and uncertainty estimate.
*   **`Collapse`**:
    *   Uses a learned query matrix $W_q$ to compute attention scores over the components of $\psi$.
    *   **Softmax Temperature**: Learned temperature parameter scales the attention distribution.
    *   **Output**: Weighted sum of $\psi$ components projected to a scalar.

### 2.3. Frontend (`frontend.hpp`, `frontend.cpp`)
Preprocessing layer for raw input sequences.
*   **`SpatialTemporalCNN`**: A multi-stage 1D CNN.
    1.  **Temporal Conv**: Aggregates local history (sliding window).
    2.  **Spatial Mixing**: Dense layer across feature channels.
    3.  **Depthwise Temporal**: Separable convolution for efficient long-term dependency capture.
    4.  **Projection**: Maps to the embedding dimension required by the `EntangledCell`.
*   Uses **ELU** (Exponential Linear Unit) activations.

### 2.4. Training & Optimization (`trainer.hpp`, `trainer.cpp`)
*   **`SequenceTrainer`**: Manages the training loop.
    *   **BPTT**: Implements full Backpropagation Through Time.
    *   **`optimizer_`**: Uses **AdamW** (Adam with decoupled weight decay) for parameter updates.
    *   **Regularization**: Computes losses for PSD constraints (`reg_beta`) and L2 penalties (`reg_eta`).
*   **`TrainerWithScheduler`**: Wraps the trainer with a Cosine Annealing learning rate scheduler.

### 2.5. Calibration (`calibrator.hpp`, `calibrator.cpp`)
Post-hoc calibration of model predictions.
*   **`Calibrator`**: Supports `Identity` (sigmoid) or `Platt` scaling to map raw margins to calibrated probabilities/reliabilities.
*   Loads configuration from JSON files.

## 3. Applications (`apps/`)

### 3.1. `bicep_to_enn`
The primary bridge between BICEP simulations and ENN training.
*   **Input**: Reads CSV files generated by BICEP (converted from Parquet).
*   **Pipeline**:
    1.  Parses trajectories (features, targets, steps).
    2.  Hashes inputs for data integrity/deduplication checks.
    3.  Trains the ENN using `SequenceTrainer`.
    4.  Evaluates performance (Loss, Accuracy).
    5.  **Telemetry**: Exports detailed predictions (`enn_predictions.csv`), including:
        *   `q_pred`: Predicted committor probability.
        *   `obs_reliability`: Calibrated reliability score (used by FusionAlpha).
        *   `epistemic_unc`: Internal uncertainty metrics.
        *   `alpha_entropy`: Entropy of the collapse attention mechanism (proxy for uncertainty).

## 4. Build System

*   **CMake**: Modern build configuration (`CMakeLists.txt`).
*   **Makefile**: Legacy/Simple build script.
*   **Dependencies**: Requires `Eigen3` for matrix operations.

## 5. Usage Workflow

1.  **Generate Data**: Run BICEP to create trajectory CSVs.
2.  **Train**:
    ```bash
    ./apps/bicep_to_enn data/parity_data.csv --telemetry out.csv
    ```
3.  **Consume**: The output `out.csv` is used by the FusionAlpha planner to set priors on the graph.
